<!-- passer_exam.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Examen en ligne</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .question-box { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; }
        .timer { font-weight: bold; color: red; }
        #submitBtn { margin-top: 10px; }
        .media { margin: 10px 0; }
        .media img, .media video { max-width: 100%; height: auto; }
        .media audio { width: 100%; }
    </style>
</head>
<body>
    <h1>Examen</h1>
    <div id="question-container" class="question-box">
        <p id="question-text">Chargement de la question...</p>
        <div id="media-container"></div>
        <div id="options-container"></div>
        <input type="text" id="answer-text" placeholder="Votre réponse ici..." style="display:none"/>
        <p>Temps restant : <span id="timer" class="timer">0</span> secondes</p>
        <button id="submitBtn">Soumettre la réponse</button>
    </div>

    <script>
                   window.addEventListener('beforeunload',(e)=>e.preventDefault())

        let currentQuestionId = null;
        let timer = 0;
        let timerInterval = null;

        async function fetchNextQuestion() {
            const response = await fetch('/api/next-question');
            const data = await response.json();
            if (data.finished) {
                window.location.href = "/exam-finished.html";
                return;
            }
            currentQuestionId = data._id || data.id;
            document.getElementById('question-text').textContent = data.statement;

            // Affichage des médias associés
            const mediaContainer = document.getElementById('media-container');
            mediaContainer.innerHTML = '';
            if (data.media && data.media.length) {
                data.media.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'media';
                    switch (m.type) {
                        case 'image':
                            div.innerHTML = `<img src="${m.url}" alt="${m.name || ''}"/>`;
                            break;
                        case 'audio':
                            div.innerHTML = `<audio controls src="${m.url}"></audio>`;
                            break;
                        case 'video':
                            div.innerHTML = `<video controls src="${m.url}"></video>`;
                            break;
                    }
                    mediaContainer.appendChild(div);
                });
            }

            document.getElementById('options-container').innerHTML = '';
            document.getElementById('answer-text').style.display = 'none';

            if (data.type === 'qcm') {
                data.options.forEach(opt => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" name="option" value="${opt.text}"/> ${opt.text}`;
                    document.getElementById('options-container').appendChild(label);
                    document.getElementById('options-container').appendChild(document.createElement('br'));
                });
            } else if (data.type === 'direct') {
                document.getElementById('answer-text').style.display = 'block';
            }

            startTimer(data.duration);
        }

        function startTimer(duration) {
            clearInterval(timerInterval);
            timer = duration;
            document.getElementById('timer').textContent = timer;
            timerInterval = setInterval(() => {
                timer--;
                document.getElementById('timer').textContent = timer;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    submitAnswer();
                }
            }, 1000);
        }

        async function submitAnswer() {
            clearInterval(timerInterval);
            let answer = null;
            if (document.getElementById('answer-text').style.display !== 'none') {
                answer = document.getElementById('answer-text').value;
            } else {
                const selected = Array.from(document.querySelectorAll('input[name="option"]:checked'));
                answer = selected.map(i => i.value);
            }

            await fetch('/api/submit-answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ questionId: currentQuestionId, answer })
            });
            fetchNextQuestion();
        }

        document.getElementById('submitBtn').addEventListener('click', submitAnswer);

        window.onload = fetchNextQuestion;
    </script>
</body>
</html>
